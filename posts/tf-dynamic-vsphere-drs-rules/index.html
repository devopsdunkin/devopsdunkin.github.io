<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <title>terraform - dynamically created vSphere anti-affinity rules - devops with dunkin</title>
    
    <meta name="description" content="As we&rsquo;ve continued to mature our Terraform modules, we have been working to give our operations team more flexbility in how they are consumed. We wanted to make sure if more than one server was being deployed from a single configuration, that vSphere DRS anti-affinity rules would be created for them. I think we&rsquo;ve all forgotten to create an anti-affinity rule or two. So now, our Terraform does this for us.">
    <meta name="author" content="">
    
    <link href="https://devopsdunkin.github.io/an-old-hope.min.css" rel="stylesheet">
    <link href="https://devopsdunkin.github.io/style.css" rel="stylesheet">
    
    <link rel="apple-touch-icon" href="https://devopsdunkin.github.io/apple-touch-icon.png">
    <link rel="icon" href="https://devopsdunkin.github.io/favicon.ico">
    
    <meta name="generator" content="Hugo 0.59.0" />
    
    <link rel="alternate" type="application/atom+xml" href="https://devopsdunkin.github.io/index.xml" title="devops with dunkin">
    
    
    
    <script>
      function setTheme() {
        const time = new Date();

        const prev = localStorage.getItem('date');
        const date = String(time.getMonth() + 1) + '.' + String(time.getDate());

        const now = time.getTime();
        let sunrise;
        let sunset;

        function setBodyClass() {
          if (now > sunrise && now < sunset) return;
          document.body.classList.add('dark');
        }

        if (date !== prev) {
          fetch('https://api.ipgeolocation.io/astronomy?apiKey=5ed37d85103e4defa5df4c5298ed5215')
            .then(res => res.json())
            .then(data => {
              sunrise = data.sunrise.split(':').map(Number);
              sunset = data.sunset.split(':').map(Number);
            })
            .catch(() => {
              sunrise = [7, 0];
              sunset = [19, 0];
            })
            .finally(() => {
              sunrise = time.setHours(sunrise[0], sunrise[1], 0);
              sunset = time.setHours(sunset[0], sunset[1], 0);
              setBodyClass();
              localStorage.setItem('sunrise', sunrise);
              localStorage.setItem('sunset', sunset);
            });
          localStorage.setItem('date', date);
        } else {
          sunrise = Number(localStorage.getItem('sunrise'));
          sunset = Number(localStorage.getItem('sunset'));
          setBodyClass();
        }
      }
    </script>
  </head>
  <body class="single">
    <script>
      setTheme();
    </script>
    <header class="header">
      <nav class="nav">
        
        <p class="logo"><a href="https://devopsdunkin.github.io/">devops with dunkin</a></p>
        
        
        <ul class="menu">
          
          <li>
            <a href="/">home</a>
          </li>
          
          <li>
            <a href="/posts/">posts</a>
          </li>
          
          <li>
            <a href="/about/">about</a>
          </li>
          
        </ul>
        
      </nav>
    </header>
    <main class="main">


<article class="post-single">
  <header class="post-header">
    <h1 class="post-title">terraform - dynamically created vSphere anti-affinity rules</h1>
    <div class="post-meta">December 8, 2019</div>
  </header>
  <div class="post-content"><p>As we&rsquo;ve continued to mature our Terraform modules, we have been working to give our operations team more flexbility in how they are consumed. We wanted to make sure if more than one server was being deployed from a single configuration, that vSphere DRS anti-affinity rules would be created for them. I think we&rsquo;ve all forgotten to create an anti-affinity rule or two. So now, our Terraform does this for us. If we pass in more than one IP address through the <code>ip_addresses</code> list variable, then the ternary should return 1, which tells Terraform to create the resource. Otherwise, it should return 0 and no rules will be created.</p>

<pre><code class="language-hcl">resource &quot;vsphere_virtual_machine&quot; &quot;web-servers&quot; {
    ...
    &lt;server config&gt;
    ...
}

resource &quot;vsphere_compute_cluster_vm_anti_affinity_rule&quot; &quot;web_server_farm_anti_affinity_rule&quot; {
    count = length(var.ip_addresses) &gt; 1 ? 1 : 0

    name                = &quot;web-server-farm-anti-affinity-rule&quot;
    compute_cluster_id  = &quot;${data.vsphere_compute_cluster.cluster.id}&quot;
    virtual_machine_ids = &quot;${vsphere_virtual_machine.web-servers.*.id}&quot;
}

output &quot;anti-affinity-rule-name&quot; {
    value = &quot;${vsphere_compute_cluster_vm_anti_affinity_rule.cluster_vm_anti_affinity_rule.*.name}&quot;
}
</code></pre>

<p>Since this was all done in our module, we have been able to abstract this away from the user, so they don&rsquo;t need to know a bunch of details. All they need to do is decide how many servers they need and define the IP addresses. We just made sure to include some documentation so they would be aware that the rules would be created.</p>

<p>Cheers!</p>
</div>
  
  <footer class="post-footer">
    <ul class="post-tags">
      
      
      <li><a href="https://devopsdunkin.github.io/tags/terraform">terraform</a></li>
      
      
      <li><a href="https://devopsdunkin.github.io/tags/vmware">vmware</a></li>
      
      
      <li><a href="https://devopsdunkin.github.io/tags/vsphere">vsphere</a></li>
      
      
      <li><a href="https://devopsdunkin.github.io/tags/drs">drs</a></li>
      
    </ul>
  </footer>
  
  
  
  
  
</article>

</main>
<footer class="footer">
  <span>&copy; 2020 <a href="https://devopsdunkin.github.io/">devops with dunkin</a></span>
  <span>&middot;</span>
  <span>Powered by <a href="https://gohugo.io/" rel="noopener" target="_blank">Hugo️️</a>️</span>
  <span>&middot;</span>
  <span>Theme️ <a href="https://github.com/nanxiaobei/hugo-paper" rel="noopener" target="_blank">Paper</a></span>
</footer>
<script src="https://devopsdunkin.github.io/highlight.min.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>
</body>
</html>

